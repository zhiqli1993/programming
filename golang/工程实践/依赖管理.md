# 依赖管理

## 概述
Go语言的依赖管理经历了多个发展阶段，从最初的GOPATH到dep工具，再到现在官方推荐的Go Modules。本文档介绍Go Modules的工作原理、使用方法以及在大型项目中的最佳实践，帮助开发者有效管理项目依赖，确保构建的一致性和可重现性。

## 基本语法/用法

### 初始化模块
创建新模块:
```bash
# 在项目根目录下执行
go mod init github.com/username/project
```

### 添加依赖
通过导入并构建自动添加依赖:
```bash
# 在代码中导入依赖包
import "github.com/gin-gonic/gin"

# 执行构建或测试命令会自动下载依赖
go build ./...
```

手动添加特定版本依赖:
```bash
go get github.com/gin-gonic/gin@v1.8.1
```

### 依赖版本管理
列出当前依赖:
```bash
go list -m all
```

升级依赖到最新版本:
```bash
go get -u github.com/gin-gonic/gin
```

升级所有依赖:
```bash
go get -u all
```

降级到特定版本:
```bash
go get github.com/gin-gonic/gin@v1.7.0
```

### 整理依赖
移除未使用的依赖:
```bash
go mod tidy
```

### 依赖本地化
将依赖复制到vendor目录:
```bash
go mod vendor
```

## 示例代码

### 基本的go.mod文件
```go
module github.com/username/myproject

go 1.19

require (
    github.com/gin-gonic/gin v1.8.1
    github.com/go-sql-driver/mysql v1.6.0
    golang.org/x/crypto v0.0.0-20220829220503-c86fa9a7ed90
)

require (
    github.com/gin-contrib/sse v0.1.0 // indirect
    github.com/go-playground/locales v0.14.0 // indirect
    // 其他间接依赖...
)

exclude github.com/problematic/dependency v1.0.0

replace github.com/original/package => github.com/fork/package v1.1.0
```

### 使用replace指令进行本地开发
```go
// go.mod
module github.com/username/myproject

go 1.19

require (
    github.com/username/mylibrary v0.1.0
    // 其他依赖...
)

// 开发时使用本地版本
replace github.com/username/mylibrary => ../mylibrary
```

### 使用工作区进行多模块开发(Go 1.18+)
```
# go.work
go 1.19

use (
    ./myapp
    ./mylibrary
)
```

## 常见问题与解决方案

1. **依赖冲突问题**
   - 问题：不同模块依赖同一包的不同版本
   - 解决：Go采用最小版本选择(MVS)算法自动解决，必要时使用replace指令强制指定版本

2. **私有仓库访问问题**
   - 问题：无法下载私有仓库中的依赖
   - 解决：配置GOPRIVATE环境变量和Git凭证
   ```bash
   go env -w GOPRIVATE=github.com/mycompany/*,gitlab.com/mycompany/*
   ```

3. **代理访问问题**
   - 问题：某些地区无法访问默认的Go代理
   - 解决：配置GOPROXY环境变量
   ```bash
   go env -w GOPROXY=https://goproxy.cn,direct
   ```

4. **版本不兼容问题**
   - 问题：依赖的API发生了不兼容变化
   - 解决：锁定特定版本或使用replace指令指向兼容的fork版本

## 进阶内容

### 语义化版本控制
Go Modules依赖语义化版本(Semantic Versioning)原则:
- 主版本号(v1, v2): 不兼容的API变更
- 次版本号(v1.1, v1.2): 向后兼容的功能新增
- 修订号(v1.1.1, v1.1.2): 向后兼容的问题修复

### 主版本升级策略
Go Modules要求v2及以上主版本使用不同的模块路径:
```go
// v1版本
module github.com/username/mymodule

// v2版本
module github.com/username/mymodule/v2
```

### 依赖图分析
查看依赖关系图:
```bash
go mod graph | grep github.com/username/myproject
```

可视化依赖图(使用第三方工具):
```bash
# 安装工具
go install github.com/psampaz/go-mod-outdated@latest

# 查看过时依赖
go list -u -m all | go-mod-outdated
```

### 模块缓存管理
查看缓存位置:
```bash
go env GOMODCACHE
```

清理缓存:
```bash
go clean -modcache
```

### 发布模块的最佳实践
1. 使用语义化版本标签
2. v2+版本在模块路径中包含主版本
3. 每个发布版本创建Git标签
4. 维护CHANGELOG文档
5. 向后兼容性保障

## 相关知识点
- [包和模块](../基础知识/包和模块.md)
- [项目结构与组织](项目结构与组织.md)
- [版本控制最佳实践](版本控制最佳实践.md)
